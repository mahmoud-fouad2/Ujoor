// Prisma Schema for Ujoor HR Platform
// Multi-tenant HR management system

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// =============================================
// MULTI-TENANCY
// =============================================

model Tenant {
  id                String   @id @default(cuid())
  name              String
  nameAr            String?
  slug              String   @unique
  domain            String?  @unique
  logo              String?
  
  // Subscription
  plan              TenantPlan @default(TRIAL)
  planExpiresAt     DateTime?
  maxEmployees      Int        @default(10)
  
  // Settings
  settings          Json?
  timezone          String     @default("Asia/Riyadh")
  currency          String     @default("SAR")
  weekStartDay      Int        @default(0) // 0 = Sunday
  
  // Status
  status            TenantStatus @default(ACTIVE)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Relations
  users             User[]
  employees         Employee[]
  departments       Department[]
  jobTitles         JobTitle[]
  shifts            Shift[]
  attendanceRecords AttendanceRecord[]
  attendanceRequests AttendanceRequest[]
  holidays          Holiday[]
  leaveTypes        LeaveType[]
  leaveRequests     LeaveRequest[]
  leaveBalances     LeaveBalance[]
  documents         Document[]
  announcements     Announcement[]
  salaryStructures  SalaryStructure[]
  payrollPeriods    PayrollPeriod[]
  payrollPayslips   PayrollPayslip[]
  trainingCourses   TrainingCourse[]
  trainingEnrollments TrainingEnrollment[]
  evaluationCycles  EvaluationCycle[]
  employeeEvaluations EmployeeEvaluation[]
  performanceGoals  PerformanceGoal[]
  notifications     Notification[]
  supportTickets    SupportTicket[]
  workLocations     TenantWorkLocation[]
  attendancePolicy  TenantAttendancePolicy?
  jobPostings       JobPosting[]
  applicants        Applicant[]
  interviews        Interview[]
  
  @@index([slug])
  @@index([status])
}

model TenantWorkLocation {
  id           String   @id @default(cuid())
  tenantId     String
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  name         String
  nameAr       String?
  address      String?

  lat          Decimal  @db.Decimal(10, 8)
  lng          Decimal  @db.Decimal(11, 8)
  radiusMeters Int      @default(150)

  isActive     Boolean  @default(true)

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  checkInRecords  AttendanceRecord[] @relation("CheckInWorkLocation")
  checkOutRecords AttendanceRecord[] @relation("CheckOutWorkLocation")

  @@index([tenantId])
  @@index([tenantId, isActive])
}

model TenantAttendancePolicy {
  id                          String   @id @default(cuid())
  tenantId                    String   @unique
  tenant                      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  enforceGeofence             Boolean  @default(false)
  allowCheckInWithoutLocation Boolean  @default(true)
  maxAccuracyMeters           Int      @default(50)

  createdAt                   DateTime @default(now())
  updatedAt                   DateTime @updatedAt
}

enum TenantPlan {
  TRIAL
  BASIC
  PROFESSIONAL
  ENTERPRISE
}

enum TenantStatus {
  PENDING
  ACTIVE
  SUSPENDED
  CANCELLED
}

// =============================================
// AUTHENTICATION & USERS
// =============================================

model User {
  id                String    @id @default(cuid())
  tenantId          String?
  tenant            Tenant?   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  email             String    @unique
  emailVerified     DateTime?
  password          String
  
  // Profile
  firstName         String
  lastName          String
  avatar            String?
  phone             String?
  
  // Role & Permissions
  role              UserRole  @default(EMPLOYEE)
  permissions       String[]  @default([])
  
  // Status
  status            UserStatus @default(ACTIVE)
  lastLoginAt       DateTime?
  
  // Security
  passwordChangedAt DateTime?
  failedLoginAttempts Int     @default(0)
  lockedUntil       DateTime?
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  // Relations
  employee          Employee?
  sessions          Session[]
  mobileDevices     MobileDevice[]
  mobileRefreshTokens MobileRefreshToken[]
  mobileChallenges  MobileChallenge[]
  auditLogs         AuditLog[]
  createdTickets    SupportTicket[] @relation("CreatedTickets")
  assignedTickets   SupportTicket[] @relation("AssignedTickets")
  ticketMessages    TicketMessage[]

  notifications     Notification[]
  notificationPreference NotificationPreference?

  processedPayrollPeriods PayrollPeriod[] @relation("PayrollProcessedBy")

  createdTrainingCourses TrainingCourse[] @relation("TrainingCourseCreatedBy")
  createdEvaluationCycles EvaluationCycle[] @relation("EvaluationCycleCreatedBy")
  createdJobPostings JobPosting[]
  
  @@index([tenantId])
  @@index([email])
  @@index([role])
}

// =============================================
// MOBILE AUTH (JWT + Refresh Tokens + Device Binding)
// =============================================

model MobileDevice {
  id           String   @id @default(cuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Client-stable device identifier (generated by the app and stored in SecureStore)
  deviceId     String

  platform     String?
  name         String?
  appVersion   String?

  lastSeenAt   DateTime?
  attestedAt   DateTime?

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  refreshTokens MobileRefreshToken[]
  challenges    MobileChallenge[]

  @@unique([userId, deviceId])
  @@index([userId])
  @@index([deviceId])
}

model MobileRefreshToken {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  mobileDeviceId String
  device         MobileDevice @relation(fields: [mobileDeviceId], references: [id], onDelete: Cascade)

  // Store only a hash of the token (token itself never stored)
  tokenHash     String   @unique

  createdAt     DateTime @default(now())
  expiresAt     DateTime
  revokedAt     DateTime?

  replacedById  String?
  replacedBy    MobileRefreshToken? @relation("RefreshRotation", fields: [replacedById], references: [id])
  replacedFrom  MobileRefreshToken[] @relation("RefreshRotation")

  userAgent     String?
  ipAddress     String?

  @@index([userId])
  @@index([mobileDeviceId])
  @@index([expiresAt])
  @@index([revokedAt])
}

model MobileChallenge {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  mobileDeviceId String
  device         MobileDevice @relation(fields: [mobileDeviceId], references: [id], onDelete: Cascade)

  nonce         String   @unique
  expiresAt     DateTime
  usedAt        DateTime?

  createdAt     DateTime @default(now())

  @@index([userId])
  @@index([mobileDeviceId])
  @@index([expiresAt])
  @@index([usedAt])
}

enum UserRole {
  SUPER_ADMIN    // Platform admin (no tenant)
  TENANT_ADMIN   // Tenant owner/admin
  HR_MANAGER     // HR department manager
  MANAGER        // Department/team manager
  EMPLOYEE       // Regular employee
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING_VERIFICATION
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expires      DateTime
  
  userAgent    String?
  ipAddress    String?
  
  createdAt    DateTime @default(now())
  
  @@index([userId])
}

// =============================================
// CORE HR - EMPLOYEES & ORGANIZATION
// =============================================

model Employee {
  id                String   @id @default(cuid())
  tenantId          String
  tenant            Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  userId            String?  @unique
  user              User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  // Basic Info
  employeeNumber    String
  firstName         String
  lastName          String
  firstNameAr       String?
  lastNameAr        String?
  email             String
  phone             String?
  avatar            String?
  
  // Personal
  nationalId        String?
  dateOfBirth       DateTime?
  gender            Gender?
  nationality       String?
  maritalStatus     MaritalStatus?
  
  // Employment
  departmentId      String?
  department        Department? @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  jobTitleId        String?
  jobTitle          JobTitle?   @relation(fields: [jobTitleId], references: [id], onDelete: SetNull)
  managerId         String?
  manager           Employee?   @relation("ManagerEmployee", fields: [managerId], references: [id], onDelete: SetNull)
  directReports     Employee[]  @relation("ManagerEmployee")
  
  hireDate          DateTime
  employmentType    EmploymentType @default(FULL_TIME)
  status            EmployeeStatus @default(ACTIVE)
  
  // Work
  shiftId           String?
  shift             Shift?      @relation(fields: [shiftId], references: [id], onDelete: SetNull)
  workLocation      String?
  
  // Compensation
  baseSalary        Decimal?    @db.Decimal(12, 2)
  currency          String      @default("SAR")
  
  // Dates
  probationEndDate  DateTime?
  contractEndDate   DateTime?
  terminationDate   DateTime?
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  
  // Relations
  attendanceRecords AttendanceRecord[]
  attendanceRequests AttendanceRequest[]
  leaveRequests     LeaveRequest[]
  leaveBalances     LeaveBalance[]
  documents         Document[]
  payrollPayslips    PayrollPayslip[]
  trainingEnrollments TrainingEnrollment[]
  evaluations       EmployeeEvaluation[]
  evaluationsAsEvaluator EmployeeEvaluation[] @relation("EvaluatorEvaluations")
  performanceGoals  PerformanceGoal[]
  managedGoals      PerformanceGoal[] @relation("ManagerGoals")
  interviews        Interview[]
  
  @@unique([tenantId, employeeNumber])
  @@index([tenantId])
  @@index([departmentId])
  @@index([managerId])
  @@index([status])
}

// =============================================
// TRAINING & DEVELOPMENT (MVP)
// =============================================

enum TrainingCourseStatus {
  DRAFT
  SCHEDULED
  ONGOING
  COMPLETED
  CANCELLED
}

enum TrainingCourseType {
  IN_PERSON
  ONLINE
  HYBRID
  SELF_PACED
  WORKSHOP
  CONFERENCE
}

enum TrainingCourseCategory {
  TECHNICAL
  SOFT_SKILLS
  LEADERSHIP
  COMPLIANCE
  SAFETY
  ONBOARDING
  OTHER
}

enum TrainingEnrollmentStatus {
  PENDING
  APPROVED
  REJECTED
  ENROLLED
  IN_PROGRESS
  COMPLETED
  FAILED
  WITHDRAWN
}

model TrainingCourse {
  id                  String   @id @default(cuid())

  tenantId            String
  tenant              Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  title               String
  titleEn             String?
  description         String
  descriptionEn       String?

  category            TrainingCourseCategory @default(OTHER)
  type                TrainingCourseType     @default(IN_PERSON)
  status              TrainingCourseStatus   @default(DRAFT)

  provider            String?
  instructorName      String?

  durationHours       Int      @default(1)
  maxParticipants     Int?

  startDate           DateTime?
  endDate             DateTime?
  location            String?
  meetingLink         String?

  objectives          Json     @default("[]")
  prerequisites       Json     @default("[]")
  targetDepartments   String[] @default([])
  targetRoles         String[] @default([])

  cost                Decimal? @db.Decimal(12, 2)
  currency            String   @default("SAR")
  isMandatory         Boolean  @default(false)

  createdByUserId     String?
  createdByUser       User?    @relation("TrainingCourseCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  enrollments         TrainingEnrollment[]

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, category])
}

model TrainingEnrollment {
  id            String   @id @default(cuid())

  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  courseId      String
  course        TrainingCourse @relation(fields: [courseId], references: [id], onDelete: Cascade)

  employeeId    String
  employee      Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  status        TrainingEnrollmentStatus @default(PENDING)
  progress      Int      @default(0)
  score         Decimal? @db.Decimal(5, 2)
  feedback      String?

  enrolledAt    DateTime @default(now())
  approvedAt    DateTime?
  completedAt   DateTime?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([tenantId, courseId, employeeId])
  @@index([tenantId])
  @@index([tenantId, courseId])
  @@index([tenantId, employeeId])
  @@index([tenantId, status])
}

// =============================================
// PERFORMANCE MANAGEMENT
// =============================================

enum EvaluationCycleStatus {
  DRAFT
  ACTIVE
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum EvaluationStatus {
  NOT_STARTED
  IN_PROGRESS
  PENDING_REVIEW
  COMPLETED
  CANCELLED
}

enum GoalStatus {
  DRAFT
  ACTIVE
  IN_PROGRESS
  COMPLETED
  CANCELLED
  OVERDUE
}

enum GoalPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

model EvaluationCycle {
  id                String   @id @default(cuid())

  tenantId          String
  tenant            Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  name              String
  nameAr            String?
  description       String?
  
  startDate         DateTime
  endDate           DateTime
  reviewDeadline    DateTime?
  
  status            EvaluationCycleStatus @default(DRAFT)
  
  templateId        String?
  
  targetDepartments String[] @default([])
  targetEmployees   String[] @default([])
  
  createdByUserId   String?
  createdByUser     User?    @relation("EvaluationCycleCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  evaluations       EmployeeEvaluation[]
  
  @@index([tenantId])
  @@index([tenantId, status])
}

model EmployeeEvaluation {
  id                String   @id @default(cuid())

  tenantId          String
  tenant            Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  cycleId           String
  cycle             EvaluationCycle @relation(fields: [cycleId], references: [id], onDelete: Cascade)

  employeeId        String
  employee          Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  evaluatorId       String?
  evaluator         Employee? @relation("EvaluatorEvaluations", fields: [evaluatorId], references: [id], onDelete: SetNull)

  status            EvaluationStatus @default(NOT_STARTED)
  
  overallScore      Decimal? @db.Decimal(5, 2)
  overallRating     String?
  
  scores            Json     @default("[]")
  strengths         String?
  areasForImprovement String?
  comments          String?
  
  employeeComments  String?
  employeeAcknowledgedAt DateTime?
  
  submittedAt       DateTime?
  reviewedAt        DateTime?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@unique([tenantId, cycleId, employeeId])
  @@index([tenantId])
  @@index([tenantId, cycleId])
  @@index([tenantId, employeeId])
  @@index([tenantId, status])
}

model PerformanceGoal {
  id                String   @id @default(cuid())

  tenantId          String
  tenant            Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  employeeId        String
  employee          Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  title             String
  titleAr           String?
  description       String
  
  category          String   @default("performance")
  priority          GoalPriority @default(MEDIUM)
  status            GoalStatus @default(DRAFT)
  
  targetValue       String?
  currentValue      String?
  unit              String?
  
  startDate         DateTime
  dueDate           DateTime
  completedAt       DateTime?
  
  progress          Int      @default(0)
  
  managerId         String?
  manager           Employee? @relation("ManagerGoals", fields: [managerId], references: [id], onDelete: SetNull)
  
  notes             String?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([tenantId])
  @@index([tenantId, employeeId])
  @@index([tenantId, status])
}

enum Gender {
  MALE
  FEMALE
}

enum MaritalStatus {
  SINGLE
  MARRIED
  DIVORCED
  WIDOWED
}

enum EmploymentType {
  FULL_TIME
  PART_TIME
  CONTRACT
  INTERN
  TEMPORARY
}

enum EmployeeStatus {
  ACTIVE
  ON_LEAVE
  SUSPENDED
  TERMINATED
  RESIGNED
}

model Department {
  id          String   @id @default(cuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  name        String
  nameAr      String?
  code        String
  description String?
  
  parentId    String?
  parent      Department?  @relation("DepartmentHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children    Department[] @relation("DepartmentHierarchy")
  
  managerId   String?
  
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  employees   Employee[]
  jobPostings JobPosting[]
  
  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([parentId])
}

model JobTitle {
  id          String   @id @default(cuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  name        String
  nameAr      String?
  code        String
  description String?
  level       Int      @default(1)
  
  minSalary   Decimal? @db.Decimal(12, 2)
  maxSalary   Decimal? @db.Decimal(12, 2)
  
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  employees   Employee[]
  jobPostings JobPosting[]
  
  @@unique([tenantId, code])
  @@index([tenantId])
}

// =============================================
// TIME & ATTENDANCE
// =============================================

model Shift {
  id                  String   @id @default(cuid())
  tenantId            String
  tenant              Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  name                String
  nameAr              String?
  code                String
  
  // Working hours (stored as "HH:mm")
  startTime           String
  endTime             String
  
  // Break
  breakStartTime      String?
  breakEndTime        String?
  breakDurationMinutes Int?
  
  // Flexibility (grace period in minutes)
  flexibleStartMinutes Int     @default(0)
  flexibleEndMinutes   Int     @default(0)
  
  // Work days (array of day numbers: 0=Sun, 6=Sat)
  workDays            Int[]    @default([0, 1, 2, 3, 4])
  
  // Overtime
  overtimeEnabled     Boolean  @default(false)
  overtimeMultiplier  Decimal? @db.Decimal(3, 2)
  
  color               String   @default("#3B82F6")
  isDefault           Boolean  @default(false)
  isActive            Boolean  @default(true)
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  employees           Employee[]
  attendanceRecords   AttendanceRecord[]
  
  @@unique([tenantId, code])
  @@index([tenantId])
}

model AttendanceRecord {
  id                String   @id @default(cuid())
  tenantId          String
  tenant            Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  employeeId        String
  employee          Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  shiftId           String?
  shift             Shift?   @relation(fields: [shiftId], references: [id], onDelete: SetNull)
  
  date              DateTime @db.Date
  
  // Check-in/out
  checkInTime       DateTime?
  checkOutTime      DateTime?
  
  // Expected times
  expectedCheckIn   DateTime?
  expectedCheckOut  DateTime?
  
  // Calculated
  status            AttendanceStatus @default(PENDING)
  lateMinutes       Int?
  earlyLeaveMinutes Int?
  totalWorkMinutes  Int?
  overtimeMinutes   Int?
  
  // Source
  checkInSource     CheckSource?
  checkOutSource    CheckSource?
  
  // Location (for mobile check-in)
  checkInLat        Decimal? @db.Decimal(10, 8)
  checkInLng        Decimal? @db.Decimal(11, 8)
  checkInAddress    String?
  checkInLocationId String?
  checkInLocation   TenantWorkLocation? @relation("CheckInWorkLocation", fields: [checkInLocationId], references: [id], onDelete: SetNull)
  checkOutLat       Decimal? @db.Decimal(10, 8)
  checkOutLng       Decimal? @db.Decimal(11, 8)
  checkOutAddress   String?
  checkOutLocationId String?
  checkOutLocation   TenantWorkLocation? @relation("CheckOutWorkLocation", fields: [checkOutLocationId], references: [id], onDelete: SetNull)
  
  notes             String?
  
  // Modification tracking
  modifiedById      String?
  modifiedAt        DateTime?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@unique([employeeId, date])
  @@index([tenantId])
  @@index([employeeId])
  @@index([date])
  @@index([status])
  @@index([checkInLocationId])
  @@index([checkOutLocationId])
}

enum AttendanceStatus {
  PENDING
  PRESENT
  ABSENT
  LATE
  EARLY_LEAVE
  ON_LEAVE
  HOLIDAY
  WEEKEND
}

enum CheckSource {
  MANUAL
  BIOMETRIC
  MOBILE
  WEB
}

model AttendanceRequest {
  id                  String   @id @default(cuid())
  tenantId            String
  tenant              Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  employeeId          String
  employee            Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  
  type                AttendanceRequestType
  status              RequestStatus @default(PENDING)
  
  date                DateTime @db.Date
  
  // For check correction
  requestedCheckIn    DateTime?
  requestedCheckOut   DateTime?
  
  // For overtime
  overtimeHours       Decimal? @db.Decimal(4, 2)
  
  // For permission
  permissionStartTime DateTime?
  permissionEndTime   DateTime?
  
  reason              String
  attachmentUrl       String?
  
  // Approval
  approvedById        String?
  approvedAt          DateTime?
  rejectionReason     String?
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  @@index([tenantId])
  @@index([employeeId])
  @@index([status])
}

enum AttendanceRequestType {
  CHECK_CORRECTION
  OVERTIME
  PERMISSION
  WORK_FROM_HOME
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

model Holiday {
  id          String   @id @default(cuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  name        String
  nameAr      String?
  date        DateTime @db.Date
  endDate     DateTime? @db.Date
  isRecurring Boolean  @default(false)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([tenantId])
  @@index([date])
}

// =============================================
// LEAVE MANAGEMENT
// =============================================

model LeaveType {
  id                String   @id @default(cuid())
  tenantId          String
  tenant            Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  name              String
  nameAr            String?
  code              String
  description       String?
  
  // Policy
  defaultDays       Int      @default(0)
  maxDays           Int?
  carryOverDays     Int      @default(0)
  carryOverExpiry   Int?     // months
  
  isPaid            Boolean  @default(true)
  requiresApproval  Boolean  @default(true)
  requiresAttachment Boolean @default(false)
  
  // Eligibility
  minServiceMonths  Int      @default(0)
  applicableGenders Gender[]
  
  color             String   @default("#3B82F6")
  isActive          Boolean  @default(true)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  leaveRequests     LeaveRequest[]
  leaveBalances     LeaveBalance[]
  
  @@unique([tenantId, code])
  @@index([tenantId])
}

model LeaveRequest {
  id              String   @id @default(cuid())
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  employeeId      String
  employee        Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  leaveTypeId     String
  leaveType       LeaveType @relation(fields: [leaveTypeId], references: [id], onDelete: Restrict)
  
  startDate       DateTime @db.Date
  endDate         DateTime @db.Date
  totalDays       Decimal  @db.Decimal(4, 1)
  
  reason          String?
  attachmentUrl   String?
  
  status          RequestStatus @default(PENDING)
  
  // Approval
  approvedById    String?
  approvedAt      DateTime?
  rejectionReason String?
  
  // Delegation
  delegateToId    String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([tenantId])
  @@index([employeeId])
  @@index([status])
  @@index([startDate, endDate])
}

model LeaveBalance {
  id            String   @id @default(cuid())
  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  employeeId    String
  employee      Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  leaveTypeId   String
  leaveType     LeaveType @relation(fields: [leaveTypeId], references: [id], onDelete: Cascade)
  
  year          Int
  
  // Days
  entitled      Decimal  @db.Decimal(5, 1) @default(0)
  used          Decimal  @db.Decimal(5, 1) @default(0)
  pending       Decimal  @db.Decimal(5, 1) @default(0)
  carriedOver   Decimal  @db.Decimal(5, 1) @default(0)
  adjustment    Decimal  @db.Decimal(5, 1) @default(0)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@unique([employeeId, leaveTypeId, year])
  @@index([tenantId])
  @@index([employeeId])
  @@index([year])
}

// =============================================
// DOCUMENTS
// =============================================

model Document {
  id            String   @id @default(cuid())
  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  employeeId    String
  employee      Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  
  // File info
  fileName      String
  originalName  String
  mimeType      String
  size          Int
  url           String   // R2 URL or key
  
  // Metadata
  category      DocumentCategory
  title         String?
  titleAr       String?
  description   String?
  
  // Dates
  issuedDate    DateTime?
  expiryDate    DateTime?
  
  // Status
  status        DocumentStatus @default(PENDING)
  
  // Approval
  uploadedById  String
  approvedById  String?
  approvedAt    DateTime?
  rejectedReason String?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([tenantId])
  @@index([employeeId])
  @@index([category])
  @@index([status])
  @@index([expiryDate])
}

enum DocumentCategory {
  PERSONAL
  EMPLOYMENT
  EDUCATIONAL
  MEDICAL
  FINANCIAL
  LEGAL
  OTHER
}

enum DocumentStatus {
  PENDING
  APPROVED
  REJECTED
  EXPIRED
}

// =============================================
// ANNOUNCEMENTS & COMMUNICATION
// =============================================

model Announcement {
  id            String   @id @default(cuid())
  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  title         String
  titleAr       String?
  content       String
  contentAr     String?
  
  type          AnnouncementType @default(INFO)
  priority      AnnouncementPriority @default(NORMAL)
  
  // Targeting
  targetAll     Boolean  @default(true)
  targetDeptIds String[] @default([])
  
  // Schedule
  publishedAt   DateTime @default(now())
  expiresAt     DateTime?
  
  // Author
  authorId      String
  
  isActive      Boolean  @default(true)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([tenantId])
  @@index([publishedAt])
  @@index([isActive])
}

enum AnnouncementType {
  INFO
  WARNING
  URGENT
  CELEBRATION
}

enum AnnouncementPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

// =============================================
// AUDIT LOG
// =============================================

model AuditLog {
  id          String   @id @default(cuid())
  tenantId    String?
  userId      String?
  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  action      String   // CREATE, UPDATE, DELETE, LOGIN, etc.
  entity      String   // Employee, Document, etc.
  entityId    String?
  
  oldData     Json?
  newData     Json?
  
  ipAddress   String?
  userAgent   String?
  
  createdAt   DateTime @default(now())
  
  @@index([tenantId])
  @@index([userId])
  @@index([entity, entityId])
  @@index([createdAt])
}

// =============================================
// SUPER ADMIN - TENANT REQUESTS
// =============================================

model TenantRequest {
  id              String   @id @default(cuid())
  
  // Company Info
  companyName     String
  companyNameAr   String?
  industry        String?
  employeeCount   String?
  
  // Contact
  contactName     String
  contactEmail    String
  contactPhone    String?
  
  // Request
  plan            TenantPlan @default(TRIAL)
  message         String?
  
  status          TenantRequestStatus @default(PENDING)
  
  // Processing
  processedById   String?
  processedAt     DateTime?
  rejectionReason String?
  tenantId        String?  // Created tenant ID if approved
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([status])
  @@index([createdAt])
}

enum TenantRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

// =============================================
// SUPPORT - TICKETS
// =============================================

model SupportTicket {
  id            String   @id @default(cuid())

  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  createdById   String
  createdBy     User     @relation("CreatedTickets", fields: [createdById], references: [id], onDelete: Restrict)

  assignedToId  String?
  assignedTo    User?    @relation("AssignedTickets", fields: [assignedToId], references: [id], onDelete: SetNull)

  subject       String
  category      String?
  priority      TicketPriority @default(NORMAL)
  status        TicketStatus   @default(OPEN)

  lastMessageAt DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  messages      TicketMessage[]

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([createdById])
  @@index([assignedToId])
  @@index([lastMessageAt])
}

model TicketMessage {
  id         String   @id @default(cuid())

  ticketId   String
  ticket     SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  senderId   String
  sender     User     @relation(fields: [senderId], references: [id], onDelete: Cascade)

  body       String
  isInternal Boolean  @default(false)

  createdAt  DateTime @default(now())

  @@index([ticketId, createdAt])
  @@index([senderId])
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  WAITING_CUSTOMER
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

// =============================================
// PAYROLL (MVP)
// =============================================

model SalaryStructure {
  id          String   @id @default(cuid())

  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  name        String
  nameAr      String
  description String?

  isDefault   Boolean  @default(false)
  isActive    Boolean  @default(true)

  // Store components as JSON to keep MVP flexible
  components  Json

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([tenantId])
  @@index([tenantId, isActive])
  @@index([tenantId, isDefault])
}

enum PayrollPeriodStatus {
  DRAFT
  PROCESSING
  PENDING_APPROVAL
  APPROVED
  PAID
  CANCELLED
}

enum PayslipStatus {
  DRAFT
  GENERATED
  SENT
  VIEWED
}

model PayrollPeriod {
  id              String   @id @default(cuid())

  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  name            String
  nameAr          String
  startDate       DateTime @db.Date
  endDate         DateTime @db.Date
  paymentDate     DateTime @db.Date

  status          PayrollPeriodStatus @default(DRAFT)

  totalGross      Decimal  @default(0) @db.Decimal(14, 2)
  totalDeductions Decimal  @default(0) @db.Decimal(14, 2)
  totalNet        Decimal  @default(0) @db.Decimal(14, 2)
  employeeCount   Int      @default(0)

  processedById   String?
  processedBy     User?    @relation("PayrollProcessedBy", fields: [processedById], references: [id], onDelete: SetNull)
  processedAt     DateTime?

  notes           String?

  payslips         PayrollPayslip[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, startDate])
}

model PayrollPayslip {
  id              String   @id @default(cuid())

  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  payrollPeriodId String
  payrollPeriod   PayrollPeriod @relation(fields: [payrollPeriodId], references: [id], onDelete: Cascade)

  employeeId      String
  employee        Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  status          PayslipStatus @default(GENERATED)
  sentAt          DateTime?
  viewedAt        DateTime?

  currency        String @default("SAR")
  paymentMethod   String @default("bank_transfer")
  bankName        String?
  accountNumber   String?

  // Snapshot amounts (keep as stored values for reporting/audit)
  basicSalary     Decimal @default(0) @db.Decimal(12, 2)
  totalEarnings   Decimal @default(0) @db.Decimal(14, 2)
  totalDeductions Decimal @default(0) @db.Decimal(14, 2)
  netSalary       Decimal @default(0) @db.Decimal(14, 2)

  // Breakdown
  earnings        Json
  deductions      Json

  // Attendance snapshot (MVP defaults)
  workingDays     Int @default(22)
  actualWorkDays  Int @default(22)
  absentDays      Int @default(0)
  lateDays        Int @default(0)
  overtimeHours   Int @default(0)

  // GOSI snapshot
  gosiEmployee    Int @default(0)
  gosiEmployer    Int @default(0)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([tenantId, payrollPeriodId, employeeId])
  @@index([tenantId])
  @@index([tenantId, payrollPeriodId])
  @@index([tenantId, employeeId])
  @@index([tenantId, status])
}

// =============================================
// NOTIFICATIONS (MVP)
// =============================================

model Notification {
  id        String   @id @default(cuid())

  tenantId  String?
  tenant    Tenant?  @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Keep as string to match frontend union types like "request-status"
  type      String
  title     String
  message   String
  link      String?

  isRead    Boolean  @default(false)
  readAt    DateTime?

  metadata  Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([userId, isRead])
  @@index([tenantId])
  @@index([createdAt])
}

model NotificationPreference {
  id        String   @id @default(cuid())

  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  email     Boolean  @default(true)
  push      Boolean  @default(true)
  sms       Boolean  @default(false)

  byType    Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// =============================================
// RECRUITMENT (Job Postings, Applicants, Interviews)
// =============================================

enum JobPostingStatus {
  DRAFT
  ACTIVE
  CLOSED
  FILLED
}

enum JobType {
  FULL_TIME
  PART_TIME
  CONTRACT
  INTERNSHIP
  TEMPORARY
}

enum ExperienceLevel {
  ENTRY
  JUNIOR
  MID
  SENIOR
  LEAD
  EXECUTIVE
}

enum ApplicationStatus {
  NEW
  SCREENING
  SHORTLISTED
  INTERVIEW
  OFFER
  ACCEPTED
  REJECTED
  WITHDRAWN
}

enum InterviewType {
  PHONE
  VIDEO
  IN_PERSON
  TECHNICAL
  HR
  FINAL
}

enum InterviewStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
  NO_SHOW
}

model JobPosting {
  id                String   @id @default(cuid())
  
  tenantId          String
  tenant            Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  title             String
  titleAr           String?
  description       String
  requirements      String?
  responsibilities  String?
  benefits          String?
  
  departmentId      String?
  department        Department? @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  
  jobTitleId        String?
  jobTitle          JobTitle? @relation(fields: [jobTitleId], references: [id], onDelete: SetNull)
  
  status            JobPostingStatus @default(DRAFT)
  jobType           JobType @default(FULL_TIME)
  experienceLevel   ExperienceLevel @default(MID)
  
  positions         Int      @default(1)
  location          String?
  
  salaryMin         Decimal? @db.Decimal(12, 2)
  salaryMax         Decimal? @db.Decimal(12, 2)
  salaryCurrency    String?  @default("SAR")
  
  postedAt          DateTime?
  closedAt          DateTime?
  expiresAt         DateTime?
  
  createdById       String
  createdBy         User     @relation(fields: [createdById], references: [id])
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  applicants        Applicant[]
  interviews        Interview[]
  
  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, departmentId])
  @@index([postedAt])
}

model Applicant {
  id                String   @id @default(cuid())
  
  tenantId          String
  tenant            Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  jobPostingId      String
  jobPosting        JobPosting @relation(fields: [jobPostingId], references: [id], onDelete: Cascade)
  
  firstName         String
  lastName          String
  email             String
  phone             String?
  
  resumeUrl         String?
  coverLetter       String?
  
  status            ApplicationStatus @default(NEW)
  source            String?  @default("career-portal")
  
  rating            Int?
  notes             String?
  
  appliedAt         DateTime @default(now())
  
  interviews        Interview[]
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@index([tenantId])
  @@index([tenantId, jobPostingId])
  @@index([tenantId, status])
  @@index([email])
}

model Interview {
  id                String   @id @default(cuid())
  
  tenantId          String
  tenant            Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  applicantId       String
  applicant         Applicant @relation(fields: [applicantId], references: [id], onDelete: Cascade)
  
  jobPostingId      String
  jobPosting        JobPosting @relation(fields: [jobPostingId], references: [id], onDelete: Cascade)
  
  type              InterviewType @default(HR)
  status            InterviewStatus @default(SCHEDULED)
  
  scheduledAt       DateTime
  duration          Int      @default(60)
  location          String?
  meetingLink       String?
  
  interviewerId     String?
  interviewer       Employee? @relation(fields: [interviewerId], references: [id], onDelete: SetNull)
  
  feedback          String?
  rating            Int?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@index([tenantId])
  @@index([tenantId, applicantId])
  @@index([tenantId, jobPostingId])
  @@index([tenantId, interviewerId])
  @@index([scheduledAt])
}
